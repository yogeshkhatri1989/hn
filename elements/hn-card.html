<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="comments.html">

<polymer-element name="hn-card" attributes="storyUrl itemId" constructor="HNCard">
  
  <template>
    <core-ajax
      auto
      url="{{storyUrl}}"
      on-core-response="{{handleResponse}}">
    </core-ajax>
 
    <div id="storyCont" layout vertical>
      
      <div id="story-loading" layout horizontal center center-justified>
        <paper-spinner active></paper-spinner>
      </div>
      
      <div id="story-details-cont" layout horizontal flex hidden>
        
        <div class="story-content" layout vertical flex>
          
          <div id="title" flex>
            <a href="{{item.url}}" target="_blank">{{item.title}}</a>
            <span class="url-cont"> ({{item.displayUrl}})</span>
          </div>

          <div class="bottom-bar" layout horizontal>
              <div id = "points" flex>
                {{item.score}} points 
              </div>
              
              <div id = "user" flex>
                by {{item.by}}
              </div>
            
              <div id = "time" flex>
                {{item.timeByAgo}}
              </div>
            

          </div>
        </div>
        
        <div id="commentsTextCont" layout vertical center center-justified>
          <div class = "comments-cont" layout vertical center center-justified>
<!--            <core-icon icon="reply"></core-icon>-->
            <div class="num-replies">{{item.kids.length}}</div>
            <div>
              {{item.commentsText}}
            </div>
            <paper-ripple class="recenteringTouch" fit></paper-ripple>
          </div>
          <paper-spinner active class="comments-loading-spinner"></paper-spinner>
        </div>
      
      </div>
    </div>
    
    <div class="story-comments-connector"></div>
    
    <div id = "commentsCont">
      <div class="comments">
      </div>
    </div>

    <style>
      :host {
        position: relative;
        opacity: 1;
        transform: translate(0, 0);
        transition: transform 500ms ease-out, opacity 300ms linear;
      }
      
      :host(.init) {
        opacity: 0;
        transform: translate(0, 40px);
      }
      
      :host(.show-comments) {
        transform: translate(-320px, 0);
      }
      
      :host(.show-comments) #storyCont {
/*        background: rgba(0, 0, 0, 0.1);*/
      }
      
      :host(.show-comments.show-comment) #storyCont {
        opacity: 1;
        background: white;
        border-right: 0;
        transition: border-right 0 500ms linear, background 250ms 0 linear;
      }
      
      :host(.show-comments.show-comment) #commentsCont {
        z-index: 100;
        transition: transform 250ms 250ms ease-out, z-index 0ms 500ms linear;
        transform: translate(639px, 0);
      }
      
      :host(.show-comments.show-comment) #commentsCont .comments {
        transition: transform 250ms 500ms ease-out;
        transform: scale(1, 1);
      }
      
      :host(.show-comments.show-comment) .story-comments-connector {
        visibility: visible;
      }
      
      #storyCont {
        box-sizing: border-box;
        
        width: 640px;
        height: 90px;
        
        position: relative;
        z-index: 10;
        
        margin: 10px;
        
        background: white;
        
        border: 1px solid lightgray;
        
        transition: border-right 0 500ms linear, background 250ms 500ms linear;
      }
      
      #story-loading {
        width: 100%;
        height: 90px;
      }
      
      #story-details-cont {
        font-size: 1em;
        width: 100%;
        margin: 0 auto;
        
      }
      
      .story-content {
        max-width: 640px;
        padding: 10px;
      }
      
      #title a {
        text-decoration: none;
        color: black;
        font-size: 1.2em;
      }
      
      .url-cont {
        color: gray;
        font-size: 0.9em;
      }
      
      .bottom-bar {
        margin-top: 10px;
        color: gray;
      }
      
      #commentsTextCont {
        width: 100px;
        position: relative;
        cursor: pointer;
      }
      
      #commentsTextCont .comments-loading-spinner {
        display: none;
      }
      
      :host(.show-comments.show-comment) #commentsTextCont.comments-loading .comments-cont {
        display: none;
      }
      
      :host(.show-comments.show-comment) #commentsTextCont.comments-loading .comments-loading-spinner {      
        display: block; 
      }
      
      .story-comments-connector {
        
        width: 12px;
        height: 88px;
        
        background: white;
        
        border: 1px solid lightgray;
        border-left: 0;
        border-right: 0;
        
        position: absolute;
        left: 647px;
        top: 10px;
        
        z-index: 1000;
        
        visibility: hidden;
        transition: visibility 0 300ms linear;
        
      }
      
      #commentsTextCont .num-replies {
        font-size: 1.3em;
      }
      
      #commentsCont {
        width: 640px;
        height: 90px;
        
        background: white;
        
        box-sizing: border-box;
        margin: 10px;
        
        border: 1px solid lightgray;
        border-left: 0;
        
        position: absolute;
        top: 0;
        left: 0;
        
        z-index: 1;
        
        transition: transform 250ms 250ms ease-out;
      }
      
      #commentsCont .comments {
        width: 630px;
        height: 600px;
        
        position: absolute;
        top: 88px;
        right: -1px;
        border: 1px solid lightgray;
        
        background: white;
        
        overflow-y: auto;
        
        transition: transform 250ms ease-out;
        transform: scale(1, 0);
        transform-origin: center center;
      }
      
    </style>

  </template>
  <script>
    Polymer({
      ready: function() {
        
      },
      itemIdChanged: function(){
        var itemId = this.itemId;  
        this.storyUrl = "https://hacker-news.firebaseio.com/v0/item/" + itemId + ".json";
      },
      handleResponse: function(data){
        this.$["story-loading"].hidden = true;
        this.$["story-details-cont"].hidden = false;
        
        this.item = data.detail.response;
        this.item.displayUrl = new URL(this.item.url).host;
        
        this.item.commentsText = (this.item.kids || []).length == 1 ? "Reply" : "Replies";
        
        var timeByAgo = (Date.now()/1000) - this.item.time;
        
        var timeNames = [
          {name: "Second", value: timeByAgo },
          {name: "Minute", value: timeByAgo / (60) },
          {name: "Hour",   value: timeByAgo / (60 * 60)},
          {name: "Day",    value: timeByAgo / (24 * 60 * 60) },
          {name: "Month",  value: timeByAgo / (30 * 24 * 60 * 60) },
          {name: "Year",   value: timeByAgo / (365 * 30 * 24 * 60 * 60) }
        ];
        
        var i;
        for (i = 0; i <= timeNames.length; i++){
          if (timeNames[i].value < 1){
            i--;
            break;
          }
        }
        
        timeByAgo = parseInt(timeNames[i].value);
        var name = timeByAgo == 1 ? timeNames[i].name : timeNames[i].name + "s";
        
        this.item.timeByAgo = timeByAgo + " " + name.toLowerCase() + " ago";
        
        var that = this;
        var isOpen = true;
        
        this.$.commentsTextCont.addEventListener("click", function(){
          
          isOpen = !isOpen;          
          
          var allElems = document.querySelectorAll("hn-card").array();
          var currIndex = allElems.indexOf(that);

          that.classList.add("show-comments");
          setTimeout(function() {
            that.classList.add("show-comment");
          }, 500);
          
          for (var i = 0; i < allElems.length; i++){
            
            if (i == currIndex) continue;
            
            var timeDelay = 150 * (i < currIndex ? currIndex - i : i - currIndex);
            
            setTimeout((function(elem){
              return function(){
                elem.classList.add("show-comments");
                elem.classList.remove("show-comment");
              }
            })(allElems[i]), timeDelay);

          }
          
          setTimeout(function(){
//            that.$.commentsTextCont.classList.add("comments-loading");
          }, 500);
          
          var commentsCont = that.$.commentsCont;
          var comments = commentsCont.querySelector(".comments");
          
          while (comments.firstChild) {
            comments.removeChild(comments.firstChild);
          }
          var windowHeight = window.innerHeight;
          
          var currentScroll = that.offsetParent.scrollTop;
          var commentTop = that.offsetTop - currentScroll;
          
          comments.style.height = (windowHeight - 84) + "px";
          comments.style.top = (-commentTop) + "px";
          comments.style.transformOrigin = "center " + commentTop + "px";
          
          
          var kids = that.item.kids;

          for (var i = 0; i < kids.length; i++){
            var storyComment = document.createElement("story-comments");
            storyComment.setAttribute("itemId", kids[i]);
            storyComment.top = true;
            comments.appendChild(storyComment);
          }
          
        });
        
        this.classList.remove("init");
        document.querySelector(".stories-loading").hidden = true;

      }
      
    });
    
  </script>
  
</polymer-element>
